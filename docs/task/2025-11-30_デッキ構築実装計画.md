# デッキ構築機能実装計画（5×5、表示は自分側2行）

## 計画作成日
2025-11-30

## 目的
5×5 の内部盤面モデルを保持しつつ、クライアントでは自分側の縦2行のみを表示できるエディタを作成する。配置はサーバで SFEN 風表記の文字列を生成して `Deck.sfen` に保存・復元する。

## 前提条件
- プロジェクトがビルドできる（`./gradlew bootRun` で起動可能）
- `koma` テーブルに駒データが登録されている（`src/main/resources/schema.sql` を参照）
- MyBatis または Spring Data の Mapper/Repository を利用可能

## スコープ（含む）
- サーバ API の実装（保存・取得、内部モデルは 5×5）
- SFEN 生成／パースロジック（5×5）
- DB 保存（`Deck` テーブルへの INSERT/SELECT）
- クライアント表示は自分側の縦2行のみ（編集はその範囲で行える）
- 単体テスト（SFEN の round‑trip）

## スコープ（含まない）
- サーバ側データの 2×5 化（内部は引き続き 5×5）
- 複雑な UI/ドラッグ操作（最小はクリックで配置）
- 正規化テーブル（`deck_positions` 等）の導入（拡張時に検討）

---

### タスク1: API とドメインの追加
**関連ファイル（例）**
- `team3.tkk_game.model.Deck`（POJO）
- `team3.tkk_game.model.Placement`（DTO: file, rank, type, owner）
- `team3.tkk_game.mapper.DeckMapper`（MyBatis インタフェース）
- `team3.tkk_game.service.DeckService`（SFEN 生成／パース、内部は 5×5）
- `team3.tkk_game.controller.DeckController`（POST /api/decks, GET /api/decks/{id}）

**作業内容**
1. `Placement` DTO を定義（file:1-5, rank:1-5, type, owner）
2. `DeckService` に SFEN 生成ロジック（5×5）とパースロジックを実装
3. `DeckMapper` に `insertDeck(name,sfen)` と `selectDeckById(id)` を定義
4. `DeckController` に保存と取得のエンドポイントを実装

**確認手順**
- POST /api/decks に JSON を送信し 201/ID を受け取る
- GET /api/decks/{id} で保存した sfen を取得できる

---

### タスク2: DB マイグレーション検討
**作業内容**
- 5×5 の用途では `Deck.sfen` の現状 `VARCHAR(255)` が十分だが、将来を見越して `TEXT` への変更を検討
- Flyway を導入する場合は `src/main/resources/db/migration/V2__deck_sfen_to_text.sql` を追加

**確認手順**
- マイグレーションを適用してテーブルが期待通りに変更される

---

### タスク3: 簡易 UI（自分側縦2行表示）
**関連ファイル**
- `src/main/resources/templates/deck_editor.html`
- `src/main/resources/static/js/deck_editor.js`

**作業内容**
1. 内部は 5×5 モデルを保持するが、画面表示は "自分側" の縦2行のみ描画・編集可能にする（例: rank 4-5 を表示）
2. 駒一覧を `/api/koma` から取得して選択可能にする
3. 保存ボタンで現在の配置（表示分のみ、または必要に応じてサーバで補完したもの）を POST する。サーバは受け取った配置を 5×5 配列に組み込み SFEN を生成する
4. 読込ボタンで GET /api/decks/{id} を呼び出し、サーバが返す 5×5 の SFEN をパースして表示対象の 2 行だけ描画する

**確認手順**
- UI で表示される 2 行に配置 → 保存 → GET で取得 → 描画の一連の動作ができること

---

## Definition of Done (DoD)
1. POST /api/decks が配置を受け取り DB に保存する（内部モデルは 5×5）
2. GET /api/decks/{id} が保存した sfen を返し、DeckService のパースで元の 5×5 配置に復元できる
3. クライアントは「自分側縦2行」を描画・編集でき、保存→読み込みで整合すること
4. DeckService の単体テストに round‑trip テストが含まれている

## テストケース（抜粋）
- 全空（`5/5/5/5/5`）
- 自分側に1駒（例: `5/5/2P1/5/5` の該当行）
- 端点ケース: 表示行が全て埋まる、全空、連続駒
- 不正入力（file/rank が 1-5 範囲外、重複配置）に対するバリデーション

## リスクと対応
- 座標系のズレ（UI とサーバで rank/file の定義を合わせる）→ API ドキュメントに明記し単体テストで検証
- クライアントが表示分のみ送信した場合の補完ロジックが必要→ サーバで受信データを 5×5 に組み込む実装を明確にする

## 注意事項
- 本計画は最小実装向け。要件変更や本番適用時は別途詳細設計を行うこと。

---

保存場所:
`tkk_game/docs/task/2025-11-30_デッキ構築実装計画.md`
