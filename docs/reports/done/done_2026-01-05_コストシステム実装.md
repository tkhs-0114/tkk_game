# コストシステム実装完了レポート

## 実装日
2026年01月05日

## 実装ブランチ
`feat/makeKoma`

## 実装内容

デッキと駒にコストの概念を導入し、デッキ作成画面でコストを表示できるようにする機能を実装しました。

### 実装したタスク

#### タスク1: KomaRule enum にコストフィールドを追加
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaRule.java`
- **変更内容**:
  - 各移動ルールにコスト値を追加（単マス移動=1、直線移動=3、ジャンプ移動=2）
  - `private final int cost` フィールドを追加
  - コンストラクタ `KomaRule(int cost)` を追加
  - `public int getCost()` メソッドを追加

#### タスク2: KomaSkill enum にコストフィールドを追加
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaSkill.java`
- **変更内容**:
  - 各スキルにコスト値を追加（NULL=0、STEALTH=5）
  - `private final int cost` フィールドを追加
  - コンストラクタ `KomaSkill(int cost)` を追加
  - `public int getCost()` メソッドを追加

#### タスク3: Koma クラスにコスト計算メソッドを追加
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/model/Koma/Koma.java`
- **変更内容**:
  - `public int getCost()` メソッドを追加
  - 移動ルールのコスト合計 + スキルのコストを計算して返却

#### タスク4: KomaDB クラスにコスト計算メソッドを追加
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java`
- **変更内容**:
  - `import java.util.List` を追加
  - `public int calculateCost(List<KomaRule> rules)` メソッドを追加
  - データベースから取得した駒情報のコストを計算

#### タスク5: DeckController で駒リストにコスト情報を含める
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java`
- **変更内容**:
  - `import java.util.HashMap` と `import java.util.Map` を追加
  - `deckmake()` メソッドを修正
  - 各駒のコストを計算し、`komaCosts` という Map でモデルに追加
  - 駒ID（キー）とコスト値（バリュー）の対応を保持

#### タスク6: deckmake.html にコスト表示UIを追加
- **ファイル**: `tkk_game/src/main/resources/templates/deckmake.html`
- **変更内容**:
  - 駒選択セレクトボックスの各 `<option>` に `data-cost` 属性を追加
  - 選択中の駒のコスト表示エリアを追加（`<span id="selected-koma-cost">`）
  - デッキの合計コスト表示エリアを追加（`<div>` と `<span id="total-deck-cost">`）
  - JavaScript で駒選択時にコストを表示する機能を実装
  - JavaScript で駒配置時にデッキの合計コストを更新する機能を実装
  - `updateTotalCost()` 関数を追加

## コスト値の設定

### 移動ルール
- **単マス移動** (8種類): コスト = 1
  - `UP`, `DOWN`, `LEFT`, `RIGHT`, `UP_LEFT`, `UP_RIGHT`, `DOWN_LEFT`, `DOWN_RIGHT`

- **直線移動** (8種類): コスト = 3
  - `LINE_UP`, `LINE_DOWN`, `LINE_LEFT`, `LINE_RIGHT`, `LINE_UP_LEFT`, `LINE_UP_RIGHT`, `LINE_DOWN_LEFT`, `LINE_DOWN_RIGHT`

- **ジャンプ移動** (8種類): コスト = 2
  - `JUMP_UP_LEFT`, `JUMP_UP_RIGHT`, `JUMP_DOWN_LEFT`, `JUMP_DOWN_RIGHT`, `JUMP_LEFT_UP`, `JUMP_LEFT_DOWN`, `JUMP_RIGHT_UP`, `JUMP_RIGHT_DOWN`

### スキル
- **NULL**: コスト = 0（スキルなし）
- **STEALTH**: コスト = 5（ステルススキル）

## 駒ごとのコスト例

| 駒名 | 移動ルール数 | スキル | コスト計算 | 合計コスト |
|------|-------------|--------|-----------|-----------|
| 王将 | 8（単マス） | NULL | 8×1 + 0 | 8 |
| 歩兵 | 1（単マス） | NULL | 1×1 + 0 | 1 |
| 香車 | 1（直線） | NULL | 1×3 + 0 | 3 |
| 桂馬 | 2（ジャンプ） | NULL | 2×2 + 0 | 4 |
| 銀将 | 5（単マス） | NULL | 5×1 + 0 | 5 |
| 金将 | 6（単マス） | NULL | 6×1 + 0 | 6 |
| 角行 | 4（直線） | NULL | 4×3 + 0 | 12 |
| 飛車 | 4（直線） | NULL | 4×3 + 0 | 12 |
| と金 | 6（単マス） | NULL | 6×1 + 0 | 6 |
| 成香 | 6（単マス） | NULL | 6×1 + 0 | 6 |
| 成桂 | 6（単マス） | NULL | 6×1 + 0 | 6 |
| 成銀 | 6（単マス） | NULL | 6×1 + 0 | 6 |
| 馬 | 8（4直線+4単マス） | NULL | 4×3 + 4×1 + 0 | 16 |
| 龍 | 8（4直線+4単マス） | NULL | 4×3 + 4×1 + 0 | 16 |
| 忍び | 5（単マス） | STEALTH | 5×1 + 5 | 10 |

## 動作確認手順

1. `gradle build` を実行してコンパイルエラーがないことを確認
   - **結果**: ✅ BUILD SUCCESSFUL

2. `gradle bootRun` でアプリケーションを起動

3. ブラウザで `http://localhost:80/` にアクセス

4. `user1` / `p@ss` でログイン

5. ホーム画面から「デッキ作成」リンクをクリック

6. デッキ作成画面で駒を選択
   - **期待される動作**: 駒を選択すると、その駒のコストが「コスト: X」と表示される
   - 例: 「王将」を選択 → 「コスト: 8」と表示

7. 盤面のマス目をクリックして駒を配置
   - **期待される動作**: 駒を配置すると、「デッキの合計コスト」が更新される
   - 例: 王将（コスト8）と歩兵（コスト1）を配置 → 合計コスト: 9

8. 複数の駒を配置して合計コストが正しく計算されることを確認
   - **期待される動作**: 配置した駒のコストが正しく合計される

9. 既存のデッキ作成機能が正常に動作することを確認
   - デッキ名入力
   - SFEN生成
   - 保存
   - **期待される動作**: コスト表示が追加されても、既存機能が正常に動作する

## 技術的な詳細

### コスト計算ロジック

#### Koma クラス
```java
public int getCost() {
  int totalCost = 0;
  // 移動ルールのコスト合計
  for (KomaRule rule : rules) {
    totalCost += rule.getCost();
  }
  // スキルのコスト
  totalCost += skill.getCost();
  return totalCost;
}
```

#### KomaDB クラス
```java
public int calculateCost(List<KomaRule> rules) {
  int totalCost = 0;
  // 移動ルールのコスト合計
  if (rules != null) {
    for (KomaRule rule : rules) {
      totalCost += rule.getCost();
    }
  }
  // スキルのコスト
  if (skill != null) {
    totalCost += KomaSkill.valueOf(skill).getCost();
  }
  return totalCost;
}
```

### フロントエンド実装

#### データ構造
- 駒選択セレクトボックスの各 `<option>` に `data-cost` 属性でコスト値を保持
- 盤面の各セルに `data-cost` 属性で配置された駒のコスト値を保持

#### イベントハンドリング
1. **駒選択時**: `change` イベントで選択された駒のコストを表示
2. **駒配置時**: `click` イベントで駒を配置し、合計コストを再計算

## 制限事項・今後の拡張

### 今回実装しなかった項目
- コスト上限の制限機能（デッキ作成時のバリデーション）
- デッキ選択画面でのコスト表示
- コスト値のデータベース保存
- 管理画面でのコスト値変更機能

### 今後の拡張案
1. デッキ作成時にコスト上限を設定し、超過時に警告を表示
2. デッキ選択画面で各デッキのコストを表示
3. コスト値をデータベースで管理し、動的に変更可能にする
4. バランス調整のため、コスト値を調整できる管理画面を作成

## まとめ

コストシステムの基本機能を正常に実装できました。デッキ作成画面で駒のコストとデッキの合計コストがリアルタイムに表示され、ユーザーがデッキ編成時にコストを考慮できるようになりました。

### 成果物
- 修正ファイル: 6ファイル
- 新規作成ファイル: 0ファイル
- ビルド結果: ✅ SUCCESS
- 実装ブランチ: `feat/makeKoma`

次のステップとして、ユーザーによる動作確認を実施し、必要に応じてコスト値のバランス調整やUI改善を行うことを推奨します。
