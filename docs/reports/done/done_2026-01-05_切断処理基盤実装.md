# 完了レポート: 切断処理基盤実装

## 日付
2026-01-05

## 作業ブランチ
feat/disconnection-handling

## 概要
相手プレイヤーが切断（ブラウザを閉じる、他サイトに移動する等）した際に、切断したプレイヤーと相手プレイヤーの両方に適切な処理を行うための基盤を実装した。

## 実装内容

### 1. サーバーサイド

#### DisconnectionHandler サービス
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/services/DisconnectionHandler.java`
- **役割**: プレイヤー切断時の処理を一元管理
- **主なメソッド**:
  - `handlePlayerDisconnection(playerName, reason)`: ゲーム中の切断処理
    - 相手プレイヤーへのSSE通知
    - プレイヤーステータスをOFFLINEに変更
    - Emitter削除
    - ゲームの終了処理
  - `handleWaitRoomDisconnection(playerName)`: 待機室での切断処理
    - ルームオーナーの場合はルーム削除
    - リクエスト送信者の場合はリクエストクリア

#### コントローラーの切断エンドポイント追加
- **GameController** (`/game/disconnect` POST):
  - ゲーム画面からの切断通知を受け付け
  - `DisconnectionHandler.handlePlayerDisconnection()` を呼び出し
  
- **MatchController** (`/match/disconnect` POST):
  - 待機室/マッチング画面からの切断通知を受け付け
  - `DisconnectionHandler.handleWaitRoomDisconnection()` を呼び出し

#### GameEventEmitterManager の拡張
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/services/GameEventEmitterManager.java`
- **追加機能**:
  - `notifyPlayerDisconnection(gameId, disconnectedPlayerName)`: 相手プレイヤーに切断を通知
  - `sendHeartbeat()`: 5秒ごとにheartbeatを送信（`@Scheduled(fixedRate = 5000)`）
  - SSEタイムアウトを30秒に設定（`Long.MAX_VALUE` → `30000L`）

#### WaitRoomEventEmitterManager の設定変更
- **ファイル**: `tkk_game/src/main/java/team3/tkk_game/services/WaitRoomEventEmitterManager.java`
- SSEタイムアウトを30秒に設定（`Long.MAX_VALUE` → `30000L`）

### 2. クライアントサイド

#### game.html
- **beforeunload イベント**: ページ離脱時に `navigator.sendBeacon('/game/disconnect')` で切断通知
- **disconnect SSEイベントリスナー**: 相手プレイヤーの切断を受信し、アラート表示後にマッチング画面へリダイレクト

#### waiting.html
- **beforeunload イベント**: ページ離脱時に `navigator.sendBeacon('/match/disconnect')` で切断通知

#### match.html
- **beforeunload イベント**: ページ離脱時にSSE接続をクローズ

## 対応する切断パターン

| パターン | 検出方法 | 処理内容 |
|----------|----------|----------|
| ブラウザを閉じる | beforeunload + sendBeacon | サーバーに切断通知 → 相手に通知 |
| 他サイトに移動 | beforeunload + sendBeacon | サーバーに切断通知 → 相手に通知 |
| ネットワーク切断 | SSEタイムアウト(30秒) | Emitter自動削除 |
| ブラウザクラッシュ | heartbeat失敗検出 | Emitter自動削除 |

## 動作確認手順

### 前提条件
1. `gradle bootRun` でアプリケーションを起動
2. ブラウザで `localhost:80/` にアクセス

### ゲーム中の切断テスト
1. **user1** でログインし、マッチング画面からルームを作成
2. 別ブラウザで **user2** でログインし、対戦リクエストを送信
3. **user1** がリクエストを承認してゲーム開始
4. **user1** のブラウザを閉じる（またはタブを閉じる）
5. **user2** の画面に「user1 さんが切断しました」アラートが表示される
6. **user2** がマッチング画面にリダイレクトされる

### 待機室での切断テスト
1. **user1** でログインし、マッチング画面からルームを作成
2. 別ブラウザで **user2** でログインしマッチング画面を開く
3. **user1** のブラウザを閉じる
4. **user2** のマッチング画面で **user1** のルームが消える

## 新規作成ファイル
| ファイル | 説明 |
|----------|------|
| `tkk_game/src/main/java/team3/tkk_game/services/DisconnectionHandler.java` | 切断処理統合サービス |

## 修正ファイル
| ファイル | 修正内容 |
|----------|----------|
| `tkk_game/src/main/java/team3/tkk_game/controller/GameController.java` | `/game/disconnect` エンドポイント追加 |
| `tkk_game/src/main/java/team3/tkk_game/controller/MatchController.java` | `/match/disconnect` エンドポイント追加 |
| `tkk_game/src/main/java/team3/tkk_game/services/GameEventEmitterManager.java` | 切断通知メソッド追加、heartbeat機能追加、タイムアウト設定変更 |
| `tkk_game/src/main/java/team3/tkk_game/services/WaitRoomEventEmitterManager.java` | タイムアウト設定変更 |
| `tkk_game/src/main/resources/templates/game.html` | beforeunload/disconnect受信処理追加 |
| `tkk_game/src/main/resources/templates/waiting.html` | beforeunload処理追加 |
| `tkk_game/src/main/resources/templates/match.html` | beforeunload処理追加 |

## 備考
- heartbeat機能は `@EnableScheduling` が既に `TkkGameApplication.java` で有効化されているため、追加設定不要
- sendBeacon APIはモダンブラウザで広くサポートされており、ページ離脱時でも確実にリクエストを送信可能
- SSEタイムアウトは30秒に設定。ネットワーク切断時は最大30秒後に検出される
