# 自作駒管理機能実装完了レポート

## 実装日時
2026年1月10日

## 実装ブランチ
現在のブランチ（ユーザー指定により変更なし）

## 実装概要
自作駒の一覧表示・削除・編集機能を実装し、デッキ作成画面で自分が使用可能な駒のみ表示するよう変更した。

## 実装内容

### 1. スキーマ変更
**ファイル:** `tkk_game/src/main/resources/schema.sql`

PlayerKomaテーブルを新規作成：
```sql
CREATE TABLE PlayerKoma(
  id INT PRIMARY KEY AUTO_INCREMENT,
  player_id INT NOT NULL,
  koma_id INT NOT NULL,
  is_owner BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (player_id) REFERENCES Player(id),
  FOREIGN KEY (koma_id) REFERENCES koma(id),
  UNIQUE(player_id, koma_id)
);
```

**ファイル:** `tkk_game/src/main/resources/data.sql`

共通駒（ID 0-14）を全プレイヤーに付与する初期データを追加。

### 2. Model作成
**ファイル:** `tkk_game/src/main/java/team3/tkk_game/model/PlayerKoma.java`

PlayerDeckと同様の設計でプレイヤーと駒の紐づけを管理するモデルを作成。

**ファイル:** `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java`

`isOwner`フィールドを追加し、駒の所有者情報を保持できるよう拡張。

### 3. Mapper作成
**ファイル:** `tkk_game/src/main/java/team3/tkk_game/mapper/PlayerKomaMapper.java`

駒とプレイヤーの紐づけCRUD操作を実装。

**ファイル:** `tkk_game/src/main/java/team3/tkk_game/mapper/KomaMapper.java`

以下のメソッドを追加：
- `selectKomasByPlayerUsername`: プレイヤー別駒取得
- `deleteKomaById`: 駒削除
- `deleteKomaRulesByKomaId`: ルール削除
- `updateKoma`: 駒更新

### 4. Controller作成
**ファイル:** `tkk_game/src/main/java/team3/tkk_game/controller/KomaController.java`

新規コントローラを作成し、以下のエンドポイントを実装：
- GET `/koma/list`: 自作駒一覧画面
- GET `/koma/make`: 駒作成画面
- POST `/koma/make/save`: 駒作成保存
- GET `/koma/edit/{id}`: 駒編集画面
- POST `/koma/update/{id}`: 駒更新
- GET `/koma/delete/{id}`: 駒削除

### 5. View作成
**ファイル:** `tkk_game/src/main/resources/templates/komalist.html`

自作駒一覧画面。deckselect.htmlを参考にしたデザイン。
- 駒名、コスト、スキルを表示
- 所有者のみ編集・削除ボタンを表示
- 共通駒には「共通駒」ラベルを表示

**ファイル:** `tkk_game/src/main/resources/templates/komaedit.html`

駒編集画面。komamake.htmlを参考にしたデザイン。
- 既存の駒情報を初期値として表示
- 移動ルール、スキル、成り先を編集可能

**ファイル:** `tkk_game/src/main/resources/static/css/komalist.css`

自作駒一覧画面用のスタイル。

**ファイル:** `tkk_game/src/main/resources/static/css/komaedit.css`

駒編集画面用のスタイル。

### 6. 既存機能修正
**ファイル:** `tkk_game/src/main/resources/templates/home.html`

「自作駒一覧」へのリンクを追加。

**ファイル:** `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java`

- デッキ作成画面で自分が使用可能な駒のみ表示するよう変更
- 駒作成関連エンドポイントをリダイレクトに変更（後方互換性）

**ファイル:** `tkk_game/src/main/resources/templates/deckmake.html`

「駒を作る」リンク先を `/koma/make` に変更。

**ファイル:** `tkk_game/src/main/resources/templates/komamake.html`

フォームのaction先を `/koma/make/save` に変更。

## DoD確認手順
1. `gradle bootRun` でアプリケーションを起動
2. ブラウザで `localhost/` にアクセスしてログイン（user1/p@ss）
3. ホーム画面に「自作駒一覧」リンクが表示されることを確認
4. 自作駒一覧画面で共通駒が表示され、「共通駒」ラベルが付いていることを確認
5. 「駒を作る」から新規駒を作成し、一覧に表示されることを確認
6. 作成した駒に編集・削除ボタンが表示されることを確認
7. 駒編集画面で駒を編集できることを確認
8. 駒を削除できることを確認（確認ダイアログ付き）
9. デッキ作成画面で自分が使用可能な駒のみ表示されることを確認

## 関連ファイル一覧
- `tkk_game/src/main/resources/schema.sql`
- `tkk_game/src/main/resources/data.sql`
- `tkk_game/src/main/java/team3/tkk_game/model/PlayerKoma.java` (新規)
- `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java`
- `tkk_game/src/main/java/team3/tkk_game/mapper/PlayerKomaMapper.java` (新規)
- `tkk_game/src/main/java/team3/tkk_game/mapper/KomaMapper.java`
- `tkk_game/src/main/java/team3/tkk_game/controller/KomaController.java` (新規)
- `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java`
- `tkk_game/src/main/resources/templates/komalist.html` (新規)
- `tkk_game/src/main/resources/templates/komaedit.html` (新規)
- `tkk_game/src/main/resources/templates/komamake.html`
- `tkk_game/src/main/resources/templates/deckmake.html`
- `tkk_game/src/main/resources/templates/home.html`
- `tkk_game/src/main/resources/static/css/komalist.css` (新規)
- `tkk_game/src/main/resources/static/css/komaedit.css` (新規)
