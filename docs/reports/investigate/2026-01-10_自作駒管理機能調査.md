# 自作駒管理機能調査レポート

## 調査日時
2026年1月10日

## 調査目的
自作駒一覧・削除・編集機能の実装方法を調査し、既存のデッキ管理の仕組みを参考にして実装計画を策定する。

## 現状分析

### 既存のデータ構造

#### komaテーブル
```sql
CREATE TABLE koma(
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  skill VARCHAR(50) DEFAULT NULL,
  update_koma INT DEFAULT -1
);
```

#### KomaRuleテーブル
```sql
CREATE TABLE KomaRule(
  id INT PRIMARY KEY AUTO_INCREMENT,
  koma_id INT,
  rule VARCHAR(50),
  FOREIGN KEY (koma_id) REFERENCES koma(id)
);
```

### 既存のPlayerDeck管理の仕組み
PlayerDeckテーブルを使用して、プレイヤーとデッキの紐づけを管理：
```sql
CREATE TABLE PlayerDeck(
  id INT PRIMARY KEY AUTO_INCREMENT,
  player_id INT NOT NULL,
  deck_id INT NOT NULL,
  is_owner BOOLEAN DEFAULT FALSE,
  ...
);
```

## 実装方針

### 1. PlayerKomaテーブルの新設
PlayerDeckと同様の設計で、プレイヤーと駒の所有関係を管理：
```sql
CREATE TABLE PlayerKoma(
  id INT PRIMARY KEY AUTO_INCREMENT,
  player_id INT NOT NULL,
  koma_id INT NOT NULL,
  is_owner BOOLEAN DEFAULT FALSE,
  FOREIGN KEY (player_id) REFERENCES Player(id),
  FOREIGN KEY (koma_id) REFERENCES koma(id),
  UNIQUE(player_id, koma_id)
);
```

### 2. 必要なコンポーネント

#### Model
- `PlayerKoma.java`: プレイヤーと駒の紐づけモデル

#### Mapper
- `PlayerKomaMapper.java`: PlayerKomaテーブルのCRUD操作
- `KomaMapper.java`: 所有者情報付き駒取得メソッド追加

#### Controller
- `KomaController.java`: 新規作成。駒一覧・作成・編集・削除機能

#### View
- `komalist.html`: 自作駒一覧画面
- `komaedit.html`: 駒編集画面
- `komalist.css`: スタイル（deckselect.cssを参照）

### 3. URL設計
```
/koma/list          - 自作駒一覧
/koma/make          - 駒作成（既存の/deck/make/komaを移動）
/koma/edit/{id}     - 駒編集画面
/koma/update/{id}   - 駒更新処理
/koma/delete/{id}   - 駒削除
```

### 4. 既存機能への変更
- `DeckController`: デッキ作成画面で自分の駒のみ表示するよう変更
- `home.html`: 自作駒一覧へのリンク追加

## 参考ファイル
- `tkk_game/src/main/java/team3/tkk_game/mapper/PlayerDeckMapper.java`
- `tkk_game/src/main/java/team3/tkk_game/model/PlayerDeck.java`
- `tkk_game/src/main/resources/templates/deckselect.html`
- `tkk_game/src/main/resources/static/css/deckselect.css`
