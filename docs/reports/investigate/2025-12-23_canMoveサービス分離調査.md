# canMoveメソッドのサービスクラス分離調査レポート

## 調査日
2025年12月23日

## 調査目的
`GameController` 内の `canMove` メソッドを `@Service` クラスに分離する実装方法を調査する。

## 調査結果

### 1. 現在のプロジェクト構造

現在のサービスクラスは以下のディレクトリに配置されている：
```
tkk_game/src/main/java/team3/tkk_game/services/
├── MatchChecker.java
└── TurnChecker.java
```

### 2. 既存サービスクラスの実装パターン

#### TurnChecker.java の実装
```java
package team3.tkk_game.services;

import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import team3.tkk_game.model.Game;
import team3.tkk_game.model.Player;
import team3.tkk_game.model.PlayerStatus;

@Service
public class TurnChecker {

  @Async
  public void checkTurn(SseEmitter emitter, Game game, String playerName) {
    // 処理内容
  }
}
```

#### MatchChecker.java の実装
```java
package team3.tkk_game.services;

import java.util.concurrent.TimeUnit;

import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;

import team3.tkk_game.model.WaitRoom;

@Service
public class MatchChecker {

  @Async
  public void checkMatch(SseEmitter emitter, WaitRoom waitRoom) {
    // 処理内容
  }
}
```

### 3. 参考実装（igakilab/springboot_samples）

GitHubの `igakilab/springboot_samples` リポジトリから以下のパターンを確認：

#### サービスクラスの基本構造
```java
package oit.is.inudaisuki.springboot_samples.service;

import org.springframework.stereotype.Service;

@Service
public class AsyncCountFruit56 {
  // フィールド
  int count = 1;

  // メソッド
  public void count(SseEmitter emitter) throws IOException {
    // 処理
  }
}
```

#### コントローラーからのサービス利用
```java
@Controller
@RequestMapping("/sample56")
public class Sample56Controller {

  @Autowired
  private AsyncCountFruit56 ac56;  // DIによるサービス注入

  @GetMapping("step1")
  public SseEmitter pushCount() {
    SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);
    ac56.count(emitter);  // サービスメソッドの呼び出し
    return emitter;
  }
}
```

### 4. 推奨する実装方法

#### 4.1 サービスクラスの作成

**ファイルパス**: `tkk_game/src/main/java/team3/tkk_game/services/MoveValidator.java`

```java
package team3.tkk_game.services;

import java.util.List;

import org.springframework.stereotype.Service;

import team3.tkk_game.model.Ban;
import team3.tkk_game.model.Koma.Koma;
import team3.tkk_game.model.Koma.KomaRule;

/**
 * 駒の移動可否を判定するサービスクラス
 */
@Service
public class MoveValidator {

  /**
   * 駒が指定された位置に移動可能かを判定する
   *
   * @param ban   盤面
   * @param fromX 移動元X座標
   * @param fromY 移動元Y座標
   * @param toX   移動先X座標
   * @param toY   移動先Y座標
   * @return 移動可能な場合はtrue
   */
  public boolean canMove(Ban ban, int fromX, int fromY, int toX, int toY) {
    // GameController.canMove() の処理をここに移動
  }
}
```

#### 4.2 コントローラーの修正

**ファイルパス**: `tkk_game/src/main/java/team3/tkk_game/controller/GameController.java`

```java
@Controller
@RequestMapping("/game")
public class GameController {

  @Autowired
  GameRoom gameRoom;
  @Autowired
  WaitRoom waitRoom;
  @Autowired
  TurnChecker turnChecker;
  @Autowired
  KomaMapper KomaMapper;
  @Autowired
  MoveValidator moveValidator;  // 追加

  // canMoveメソッドを削除し、moveValidator.canMove() を使用

  @GetMapping("/move")
  public String gameMove(Principal principal, Model model, ...) {
    // ...
    // 移動ルールを確認
    Boolean canMove = moveValidator.canMove(game.getBan(), fromX, fromY, toX, toY);  // 変更
    // ...
  }
}
```

### 5. 実装手順

1. **MoveValidator サービスクラスを作成**
   - `tkk_game/src/main/java/team3/tkk_game/services/MoveValidator.java` を新規作成
   - `@Service` アノテーションを付与
   - `canMove` メソッドを実装（GameController から移植）

2. **GameController を修正**
   - `MoveValidator` を `@Autowired` でDI
   - `canMove` メソッドを削除
   - `moveValidator.canMove()` に置き換え

3. **動作確認**
   - `gradle bootRun` でアプリケーションを起動
   - ゲーム画面で駒の移動が正常に動作することを確認

### 6. メリット

| 観点 | 説明 |
|------|------|
| 責務の分離 | コントローラーはHTTPリクエスト処理に専念 |
| テスタビリティ | MoveValidator 単体でのユニットテストが可能 |
| 再利用性 | 他のコントローラーやサービスからも利用可能 |
| 保守性 | 移動ルールの変更がサービスクラスに集約 |
| 一貫性 | 既存の TurnChecker, MatchChecker と同じパターン |

### 7. 参考URL

- [igakilab/springboot_samples - AsyncCountFruit56.java](https://github.com/igakilab/springboot_samples/blob/main/src/main/java/oit/is/inudaisuki/springboot_samples/service/AsyncCountFruit56.java)
- [igakilab/springboot_samples - Sample56Controller.java](https://github.com/igakilab/springboot_samples/blob/main/src/main/java/oit/is/inudaisuki/springboot_samples/controller/Sample56Controller.java)

## 結論

既存プロジェクトの `services/` ディレクトリに `MoveValidator.java` を作成し、`@Service` アノテーションを付与することで、既存のサービスクラス（`TurnChecker`、`MatchChecker`）と一貫性のある実装が可能。Spring の DI 機能を活用し、コントローラーからは `@Autowired` で注入して利用する。
