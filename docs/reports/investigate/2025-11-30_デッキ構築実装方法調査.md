調査レポート: `koma` から `Deck` を作成して `sfen` 方式で保存する設計と実装方針（盤面 5x5 版）

日付: 2025-11-30

対象ファイル: `src/main/resources/schema.sql`（tkk_game モジュール）

現状のスキーマ（抜粋）:

```sql
CREATE TABLE koma(
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  type VARCHAR(1)
);

CREATE TABLE Deck(
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255),
  sfen VARCHAR(255)
);
```

目的
- `koma` テーブルに登録された駒データを元に、ユーザが自由に盤面配置を作成できる UI を作成し、その配置を SFEN 形式（または SFEN 風表記）の文字列で `Deck.sfen` に保存する。今回は盤面サイズを 5×5 に限定して実装案を策定する。

要件
- ユーザは任意の駒を選び、5x5 の任意のマスに配置できること。
- 配置は SFEN 風の表記で文字列化して保存・取得できること。
- 保存した文字列から盤面を復元できること。

SFEN 方針（5x5 に合わせた要点）
- 盤面は 5 列×5 行を `/` で区切る（5 行分）。各行は左から右の順序で表記する。
- 空マスは連続数で表す（例: `2` は空マス2つ）。
- 駒表記は既存の `type` を使い、先手は大文字、後手は小文字で表記する（例: P,L,N,S,G 等）。
- 必要なら持ち駒や先後情報は sfen の拡張フィールドとして後続で追加可能とする。

設計検討
- 手軽さ重視: 既存 `Deck` の `sfen` カラムに文字列を保存する（実装コスト低）。
- 拡張性重視: 将来的に個別駒検索や部分編集が必要であれば `deck_positions` と `deck_hands` テーブルで正規化する。
- 容量対策: 5x5 の簡易 SFEN では `VARCHAR(255)` で十分だが、将来的にメタデータを付与する可能性があるため `TEXT` を検討しておく。

実装ワークフロー（5x5 短期実装案）
1. UI: 駒一覧（`koma` の内容を表示）と 5x5 エディタを作成。座標は `(file:1-5, rank:1-5)` の数値で扱う。
2. クライアントからの送信フォーマット例（JSON）:
   [{"komaId":1,"type":"P","owner":"B","file":3,"rank":2}, ...]
3. サーバ側: 受信配置をもとに 5x5 配列へ駒文字をセットし、SFEN 文字列を生成する。
4. DB 保存: INSERT INTO Deck(name,sfen) VALUES (?, ?)
5. 復元: Deck.sfen をパースして盤面データを返却し、UI で描画する。

SFEN 生成（実装ヒント・擬似コード、5x5 用）
```java
// 入力: List<Placement> placements (rank:1-5, file:1-5, type:'P', owner:'B'/'W')
char[][] board = new char[5][5];
for (char[] row : board) Arrays.fill(row, '.');
for (Placement p : placements) {
  int r = 5 - p.getRank(); // 表示と内部行順の整合に注意
  int f = p.getFile() - 1;
  char piece = p.getType().charAt(0);
  if (p.getOwner().equals("W")) piece = Character.toLowerCase(piece);
  board[r][f] = piece;
}
StringBuilder sfenBoard = new StringBuilder();
for (int r = 0; r < 5; r++) {
  int empty = 0;
  for (int f = 0; f < 5; f++) {
    char c = board[r][f];
    if (c == '.') { empty++; }
    else {
      if (empty > 0) { sfenBoard.append(empty); empty = 0; }
      sfenBoard.append(c);
    }
  }
  if (empty > 0) sfenBoard.append(empty);
  if (r < 4) sfenBoard.append('/');
}
String sfen = sfenBoard.toString();
```

例（5x5 の SFEN）
- 全空: `5/5/5/5/5`
- 中央に先手の P（大文字）を置く例: `5/5/2P1/5/5`  （行・列の座標系に合わせて変換が必要）

SQL / スキーマ注意点
- 現行 `Deck.sfen` は `VARCHAR(255)` のままで 5x5 の用途には十分だが、将来拡張を見越すなら `TEXT` への変更を推奨。
- マイグレーション管理は Flyway を推奨。スキーマの変更や初期データの管理を明確にする。

テスト観点
- 保存 → 取得 → 復元の round-trip テスト（5x5 固有ケース）
- 端点ケース: 行が全部埋まる、全空、複数駒連続など
- UI からの不正入力（file/rank が 1-5 範囲外、重複配置）に対するバリデーション

運用上の提案
- プロトタイプや学習用途では `Deck.sfen` 文字列保存で十分。
- 本番用途や改版管理が必要な場合は Flyway 導入と `sfen` のデータ型見直しを行うこと。

次のアクション候補（選択可能）
A) `Deck.sfen` を `TEXT` に変更するマイグレーション SQL を作成する。
B) SFEN 生成・パースの Java サンプル実装（Controller/Service）を作成する（5x5 対応）。
C) 5x5 駒配置用の簡易 UI（HTML/JS）モックを作成する。

作成者: 自動生成

---
保存場所:
`tkk_game/docs/reports/investigate/2025-11-30.デッキ構築実装方法調査.md`
