# 駒作成フォームのDB保存実装方法調査

## 調査日時
2026年1月4日

## 更新履歴
- 2026年1月4日: 初版作成
- 2026年1月4日: フォーム・Mapper修正反映（デフォルト値-1設定、カラム名不整合解消、@Options追加）

## 調査目的
`komamake.html`のフォームから送信されたデータを`@PostMapping("make/koma/save")`で受け取り、DB（`koma`テーブルと`komarule`テーブル）に保存する実装方法を調査する。

## 現在の実装状況

### フォームの内容（komamake.html）
```html
<form th:action="@{/deck/make/koma/save}" method="post">
  <label for="name">駒の名前:<input type="text" id="name" name="name" required></label><br>
  <label><input type="checkbox" id="UP" name="rules" value="UP">UP</label><br>
  <label><input type="checkbox" id="DOWN" name="rules" value="DOWN">DOWN</label><br>
  <label><input type="checkbox" id="LEFT" name="rules" value="LEFT">LEFT</label><br>
  <label><input type="checkbox" id="RIGHT" name="rules" value="RIGHT">RIGHT</label><br>
  <label><input type="checkbox" id="UP_LEFT" name="rules" value="UP_LEFT">UP_LEFT</label><br>
  <label><input type="checkbox" id="UP_RIGHT" name="rules" value="UP_RIGHT">UP_RIGHT</label><br>
  <label><input type="checkbox" id="DOWN_LEFT" name="rules" value="DOWN_LEFT">DOWN_LEFT</label><br>
  <label><input type="checkbox" id="DOWN_RIGHT" name="rules" value="DOWN_RIGHT">DOWN_RIGHT</label><br>
  <label>駒の成り先<select id="update" name="updateKomaId">
      <option value="-1" selected>成らない</option>
      <option th:each="k : ${canUpdateKomas}" th:value="${k.id}" th:text="${k.name}">駒名</option>
    </select></label><br>
  <label><button type="submit">作成</button>
</form>
```

**フォームから送信されるパラメータ:**
- `name`: 駒の名前（String型）
- `rules`: チェックボックスで選択された移動ルール（複数選択可能）
- `updateKomaId`: 成り先の駒ID（Integer型、デフォルト値は-1）

**修正済み:**
- ✅ セレクトボックスのデフォルト値を空文字から`-1`に変更

### 現在のController実装（DeckController.java）
```java
@PostMapping("make/koma/save")
public String saveKomaData(@RequestParam String name, Principal principal) {
  return "redirect:/deck/make";
}
```

現在は`name`のみ受け取っており、DBへの保存処理は未実装。

### DB構造

#### komaテーブル
```sql
CREATE TABLE koma(
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50) NOT NULL,
  skill VARCHAR(50) DEFAULT NULL,
  update_koma INT DEFAULT -1
);
```

#### komaruleテーブル
```sql
CREATE TABLE KomaRule(
  id INT PRIMARY KEY AUTO_INCREMENT,
  koma_id INT,
  rule VARCHAR(50),
  FOREIGN KEY (koma_id) REFERENCES koma(id)
);
```

### 既存のMapper実装（KomaMapper.java）
```java
@Mapper
public interface KomaMapper {
  @Select("SELECT id,name,skill,update_koma FROM koma")
  List<KomaDB> selectAllKoma();

  @Select("SELECT id,name,skill,update_koma FROM koma WHERE id = #{komaId}")
  KomaDB selectKomaById(Integer komaId);

  @Select("SELECT rule FROM komarule WHERE koma_id = #{komaId}")
  List<KomaRule> selectKomaRuleById(Integer komaId);

  @Insert("INSERT INTO koma(name, skill, update_koma) VALUES(#{name}, #{skill}, #{updateKoma})")
  @Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")
  void insertKoma(String name, String skill, Integer updateKoma);

  @Insert("INSERT INTO komarule(koma_id, rule) VALUES(#{komaId}, #{ruleName})")
  void insertKomaRule(int komaId, KomaRule ruleName);
}
```

**修正済み:**
- ✅ `insertKoma`メソッドに`@Options`アノテーションを追加
- ✅ `insertKomaRule`メソッドのカラム名を`rule_name`から`rule`に修正

**残課題:**
- ❌ `insertKoma`メソッドの引数が個別フィールド形式のため、KomaDBオブジェクトでIDを受け取れない
  - 現状: `void insertKoma(String name, String skill, Integer updateKoma)`
  - 必要: `void insertKoma(KomaDB koma)` に変更してオブジェクトのidフィールドに自動採番されたIDを設定できるようにする

## igakilab/springboot_samplesでの調査結果

### 1. フォームパラメータの受け取り方法

#### 単一パラメータの受け取り（Sample21Controller.java）
```java
@PostMapping("/sample25")
public String sample25(@RequestParam Integer kakeru1, @RequestParam Integer kakeru2, ModelMap model) {
    int kakeruResult = kakeru1 * kakeru2;
    model.addAttribute("kakeruResult", kakeruResult);
    return "sample24.html";
}
```

#### 複数パラメータの受け取り（Sample26Controller.java）
```java
@PostMapping("ave")
public String sample28(@RequestParam Double num1, @RequestParam Double num2, @RequestParam Double num3,
    ModelMap model) {
    ArrayList<Double> numList = new ArrayList<>();
    numList.add(num1);
    numList.add(num2);
    numList.add(num3);
    Score score = new Score(numList);
    model.addAttribute("score", score);
    return "sample26.html";
}
```

**重要:** チェックボックスで複数選択される`rules`パラメータは、以下のように配列またはListとして受け取ることができる:
```java
@RequestParam List<String> rules
// または
@RequestParam String[] rules
```

### 2. DBへのInsert処理（Sample41Controller.java & ChamberMapper.java）

#### Controllerでの処理例
```java
@PostMapping("step3")
@Transactional
public String sample43(@RequestParam String chamberName, ModelMap model, Principal prin) {
    String loginUser = prin.getName(); // ログインユーザ情報
    Chamber chamber3 = new Chamber();
    chamber3.setChamberName(chamberName);
    chamber3.setUserName(loginUser);
    chamberMapper.insertChamber(chamber3);
    model.addAttribute("chamber3", chamber3);
    return "sample43.html";
}
```

#### Mapperでの定義例
```java
@Insert("INSERT INTO chamber (userName,chamberName) VALUES (#{userName},#{chamberName});")
@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")
void insertChamber(Chamber chamber);
```

**ポイント:**
- `@Transactional`アノテーションでトランザクション管理
- `@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")`により、AUTO_INCREMENTで生成されたIDをオブジェクトに自動設定可能
- オブジェクトを引数に取ることで、フィールド名を`#{フィールド名}`でSQL内で参照可能

### 3. 複数レコードのInsert処理（Sample41Controller.java）

```java
@PostMapping("step8")
@Transactional
public String sample48(@RequestParam Double height, @RequestParam Integer age, ModelMap model, Principal prin) {
    String loginUser = prin.getName();
    UserInfo ui = new UserInfo();
    ui.setUserName(loginUser);
    ui.setAge(age);
    ui.setHeight(height);
    try {
        chamberMapper.insertUserInfo(ui);
    } catch (RuntimeException e) {
        System.out.println("Exception:" + e.getMessage());
    }
    // insert後にすべての身長が登録されているユーザを取得する
    ArrayList<ChamberUser> chamberUsers7 = chamberMapper.selectAllChamberUser();
    model.addAttribute("chamberUsers7", chamberUsers7);
    return "sample46.html";
}
```

## 実装方法の提案

### 1. Controllerメソッドの実装パターン

```java
@PostMapping("make/koma/save")
@Transactional
public String saveKomaData(
    @RequestParam String name,
    @RequestParam(required = false) List<String> rules,
    @RequestParam(required = false) Integer updateKomaId,
    Principal principal) {

    // 1. komaテーブルへの挿入
    // updateKomaIdが空の場合は-1を設定
    Integer updateKoma = (updateKomaId == null || updateKomaId == 0) ? -1 : updateKomaId;

    // KomaDBオブジェクトを作成
    KomaDB newKoma = new KomaDB();
    newKoma.setName(name);
    newKoma.setSkill(null); // skillは今回のフォームでは指定しない
    newKoma.setUpdateKoma(updateKoma);

    // komaテーブルにInsert（IDが自動採番される）
    komaMapper.insertKoma(newKoma);

    // 2. komaruleテーブルへの挿入
    if (rules != null && !rules.isEmpty()) {
        for (String ruleName : rules) {
            KomaRule komaRule = KomaRule.valueOf(ruleName);
            komaMapper.insertKomaRule(newKoma.getId(), komaRule);
        }
    }

    return "redirect:/deck/make";
}
```

### 2. Mapper修正の必要性

#### 残る問題点
- `insertKoma`メソッドが個別のフィールドを引数に取っているため、AUTO_INCREMENTで生成されたIDをKomaDBオブジェクトに設定できない
- `@Options`アノテーションは追加されているが、引数がプリミティブ型のため効果がない

#### 必要な修正
```java
// KomaDBオブジェクトを引数に取るように変更
@Insert("INSERT INTO koma(name, skill, update_koma) VALUES(#{name}, #{skill}, #{updateKoma})")
@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")
void insertKoma(KomaDB koma);
```

この修正により、`insertKoma`メソッド実行後に`koma.getId()`で自動採番されたIDを取得できるようになります。

### 3. チェックボックス未選択時の考慮

チェックボックスが1つも選択されていない場合、`rules`パラメータは`null`になる可能性があるため、`required = false`を指定する必要がある。

```java
@RequestParam(required = false) List<String> rules
```

### 4. updateKomaIdの処理

フォームでは`value="-1"`がデフォルト値として設定されているため、Integer型で直接受け取ることができる。

```java
@RequestParam Integer updateKomaId
```

ただし、安全のため`required = false`を指定し、nullチェックを行うことを推奨。

## まとめ

### 完了した修正
1. ✅ フォームのselectタグのデフォルト値を`-1`に設定
2. ✅ `insertKomaRule`メソッドのカラム名を`rule_name`から`rule`に修正
3. ✅ `insertKoma`メソッドに`@Options`アノテーションを追加

### 実装に必要な残りの手順

1. **KomaMapper.javaの修正**
   - `insertKoma`メソッドの引数を`KomaDB`オブジェクトに変更
   - これにより、AUTO_INCREMENTで生成されたIDをオブジェクトに自動設定できるようになる

2. **DeckController.javaの実装**
   - `@Transactional`アノテーションを追加
   - `rules`を`List<String>`として受け取る（`required = false`を指定）
   - `updateKomaId`を`Integer`として受け取る（`required = false`を指定）
   - `KomaDB`オブジェクトを作成してMapperで挿入
   - 挿入後の`KomaDB`から自動採番されたIDを取得
   - `rules`をループ処理してそれぞれ`komarule`テーブルに挿入

3. **エラー処理の考慮**
   - トランザクション処理により、途中でエラーが発生した場合は全てロールバック
   - 必要に応じてtry-catch文でエラーハンドリング

### 次のステップ
実装計画（docs/tasks.md）を作成し、上記の手順を具体的なタスクに分解する。

## 参考URL
- https://github.com/igakilab/springboot_samples
  - Sample41Controller.java: フォームからのデータ受け取りとDB挿入の実装例
  - ChamberMapper.java: `@Options`を使った自動採番IDの取得方法
  - Sample21Controller.java, Sample26Controller.java: `@RequestParam`の基本的な使い方
