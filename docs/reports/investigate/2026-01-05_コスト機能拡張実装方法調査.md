# コスト機能拡張実装方法調査

## 調査日
2026年01月05日

## 調査目的
以下の3つの機能を実装するための方法を調査する：
1. デッキ作成画面のSelectで全ての駒のコストを一覧表示
2. デッキにコスト上限を設ける（DB、クラス、バリデーション）
3. 駒作成画面で選択中のルールの合計コストを表示

## 要件

### 1. デッキ作成画面のSelectでコスト一覧表示
- 駒選択のセレクトボックスに「コスト: 駒名」の形式で表示
- 例：「1: 歩兵」「8: 王将」「12: 飛車」

### 2. デッキにコスト上限を設ける
- データベースの `Deck` テーブルに `cost` カラムを追加（計算されたデッキコストを保存）
- `Deck` クラスに `cost` フィールドを追加
- コスト上限は `DeckController` に定数としてハードコーディング（例: `private static final int COST_LIMIT = 50;`）
- デッキ作成画面でコスト上限を表示
- デッキの合計コストが上限を超えた場合、警告を表示
- デッキ保存時にサーバー側でもバリデーションを実施
- 保存時にSFENから計算したコストをDBに保存

### 3. 駒作成画面でコスト表示
- チェックボックスで選択中の移動ルールの合計コストをリアルタイム表示
- JavaScript で計算して表示

## 実装方法の検討

### 1. セレクトボックスへのコスト表示

#### 実装方法
Thymeleaf の `th:text` 属性を使用してコスト情報を含めた表示文字列を生成する。

**現状**
```html
<option th:each="k : ${komas}" th:value="${k.id}" th:text="${k.name}">駒名</option>
```

**変更後**
```html
<option th:each="k : ${komas}" th:value="${k.id}"
        th:text="${komaCosts[k.id]} + ': ' + ${k.name}"
        th:attr="data-cost=${komaCosts[k.id]}">駒名</option>
```

#### メリット
- 既存のコード（`komaCosts` Map）を再利用できる
- Thymeleaf の文字列連結で簡単に実装可能
- ユーザーが駒のコストを一目で確認できる

### 2. デッキコスト上限の実装

#### 2-1. データベーススキーマの変更

**schema.sql の修正**
```sql
CREATE TABLE Deck(
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255),
  sfen VARCHAR(255),
  cost_limit INT DEFAULT 50
);
```

- `cost_limit` カラムを追加
- デフォルト値を50に設定（バランス調整可能）

**data.sql の修正**
既存のサンプルデッキにコスト上限を追加
```sql
INSERT INTO Deck (name, sfen, cost_limit) VALUES ('sample', '5/2[0]2', 50);
```

#### 2-2. Deck クラスの修正

**Deck.java**
```java
public class Deck {
  int id;
  String name;
  String sfen;
  Integer costLimit; // コスト上限を追加

  // getter/setter を追加
  public Integer getCostLimit() {
    return costLimit;
  }

  public void setCostLimit(Integer costLimit) {
    this.costLimit = costLimit;
  }
}
```

#### 2-3. DeckMapper の修正

**DeckMapper.java**
```java
@Insert("INSERT INTO Deck(name, sfen, cost_limit) VALUES(#{name}, #{sfen}, #{costLimit})")
@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")
int insertDeck(Deck deck);

@Select("SELECT id, name, sfen, cost_limit AS costLimit FROM Deck")
List<Deck> selectAllDecks();

@Select("SELECT id, name, sfen, cost_limit AS costLimit FROM Deck WHERE id = #{id}")
Deck selectDeckById(int id);
```

#### 2-4. デッキ作成画面の修正

**deckmake.html**

フォームにコスト上限入力フィールドを追加：
```html
<label for="cost-limit">コスト上限：</label>
<input id="cost-limit" name="costLimit" type="number" value="50" min="1" required />
```

JavaScript でコスト上限チェック：
```javascript
function checkCostLimit() {
  const totalCost = getTotalCost();
  const costLimit = parseInt(document.getElementById('cost-limit').value, 10);
  const warningDiv = document.getElementById('cost-warning');

  if (totalCost > costLimit) {
    warningDiv.textContent = `警告: デッキコストが上限を超えています (${totalCost}/${costLimit})`;
    warningDiv.style.color = 'red';
    warningDiv.style.display = 'block';
    return false;
  } else {
    warningDiv.style.display = 'none';
    return true;
  }
}

// フォーム送信時のバリデーション
document.getElementById('deck-form').addEventListener('submit', (e) => {
  // ... 既存のチェック ...
  if (!checkCostLimit()) {
    e.preventDefault();
    alert('デッキのコストが上限を超えています。駒を減らしてください。');
    return;
  }
  // ... SFEN設定 ...
});
```

#### 2-5. サーバー側バリデーション

**DeckController.java の saveDeck メソッド修正**
```java
@PostMapping("/save")
public String saveDeck(
    @RequestParam String deckName,
    @RequestParam String sfen,
    @RequestParam Integer costLimit,
    Principal principal,
    RedirectAttributes redirectAttributes) {

  // SFEN から駒IDリストを抽出
  List<Integer> komaIds = extractKomaIdsFromSfen(sfen);

  // デッキの合計コストを計算
  int totalCost = 0;
  for (Integer komaId : komaIds) {
    KomaDB koma = komaMapper.selectKomaById(komaId);
    List<KomaRule> rules = komaMapper.selectKomaRuleById(komaId);
    totalCost += koma.calculateCost(rules);
  }

  // コスト上限チェック
  if (totalCost > costLimit) {
    redirectAttributes.addFlashAttribute("error",
        "デッキのコストが上限を超えています (" + totalCost + "/" + costLimit + ")");
    return "redirect:/deck/make";
  }

  // 保存処理
  Deck deck = new Deck();
  deck.setName(deckName);
  deck.setSfen(sfen);
  deck.setCostLimit(costLimit);
  deckMapper.insertDeck(deck);

  redirectAttributes.addFlashAttribute("success", "デッキを保存しました");
  return "redirect:/deck/make";
}

// SFEN から駒IDリストを抽出するヘルパーメソッド
private List<Integer> extractKomaIdsFromSfen(String sfen) {
  List<Integer> komaIds = new ArrayList<>();
  Pattern pattern = Pattern.compile("\\[(\\d+)\\]");
  Matcher matcher = pattern.matcher(sfen);
  while (matcher.find()) {
    komaIds.add(Integer.parseInt(matcher.group(1)));
  }
  return komaIds;
}
```

### 3. 駒作成画面でのコスト表示

#### 実装方法

**komamake.html の修正**

コスト表示エリアを追加：
```html
<div style="margin: 10px 0;">
  <strong>選択中のルールのコスト：</strong>
  <span id="rule-cost-display" style="font-size: 1.2em; color: #0066cc;">0</span>
</div>
```

JavaScript でコスト計算：
```javascript
// 各ルールのコストを定義
const ruleCosts = {
  'UP': 1, 'DOWN': 1, 'LEFT': 1, 'RIGHT': 1,
  'UP_LEFT': 1, 'UP_RIGHT': 1, 'DOWN_LEFT': 1, 'DOWN_RIGHT': 1,
  'LINE_UP': 3, 'LINE_DOWN': 3, 'LINE_LEFT': 3, 'LINE_RIGHT': 3,
  'LINE_UP_LEFT': 3, 'LINE_UP_RIGHT': 3, 'LINE_DOWN_LEFT': 3, 'LINE_DOWN_RIGHT': 3,
  'JUMP_UP_LEFT': 2, 'JUMP_UP_RIGHT': 2, 'JUMP_DOWN_LEFT': 2, 'JUMP_DOWN_RIGHT': 2,
  'JUMP_LEFT_UP': 2, 'JUMP_LEFT_DOWN': 2, 'JUMP_RIGHT_UP': 2, 'JUMP_RIGHT_DOWN': 2
};

// コスト更新関数
function updateRuleCost() {
  let totalCost = 0;
  const checkboxes = document.querySelectorAll('input[name="rules"]:checked');
  checkboxes.forEach(checkbox => {
    const ruleName = checkbox.value;
    totalCost += ruleCosts[ruleName] || 0;
  });
  document.getElementById('rule-cost-display').textContent = totalCost;
}

// 各チェックボックスに change イベントを追加
document.querySelectorAll('input[name="rules"]').forEach(checkbox => {
  checkbox.addEventListener('change', updateRuleCost);
});
```

## 必要な実装ファイル

### データベース関連
1. `tkk_game/src/main/resources/schema.sql` - Deck テーブルに `cost_limit` カラム追加
2. `tkk_game/src/main/resources/data.sql` - サンプルデッキに `cost_limit` 追加

### モデル・マッパー
3. `tkk_game/src/main/java/team3/tkk_game/model/Deck.java` - `costLimit` フィールド追加
4. `tkk_game/src/main/java/team3/tkk_game/mapper/DeckMapper.java` - SQL に `cost_limit` 追加

### コントローラー
5. `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java` - バリデーション追加

### ビュー
6. `tkk_game/src/main/resources/templates/deckmake.html` - コスト上限入力・警告表示追加
7. `tkk_game/src/main/resources/templates/komamake.html` - コスト表示追加

## 技術的な考慮事項

### 1. SFEN パースの実装
- 正規表現 `\[(\d+)\]` で駒IDを抽出
- Java の `Pattern` と `Matcher` を使用

### 2. フラッシュメッセージの表示
- `RedirectAttributes` を使用してエラー・成功メッセージを渡す
- Thymeleaf で `${error}` や `${success}` を表示

### 3. デフォルトのコスト上限値
- 50 を推奨（調整可能）
- 王将(8) + 飛車(12) + 角行(12) + 金将x2(12) + 歩兵x5(5) = 49

### 4. エラーハンドリング
- フロントエンド: JavaScript でリアルタイムチェック
- バックエンド: POST 時に再度バリデーション
- 二重チェックでセキュリティ向上

## 参考情報
- Spring MVC Flash Attributes: [Spring Documentation](https://docs.spring.io/spring-framework/reference/web/webmvc/mvc-controller/ann-methods/flash-attributes.html)
- Thymeleaf 文字列連結: [Thymeleaf Tutorial](https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html#literal-substitutions)
- Java 正規表現: [Pattern Class](https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/regex/Pattern.html)

## 次のステップ
調査結果を基に、計画フェーズで詳細な実装計画を立てる。
