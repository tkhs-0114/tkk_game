# コストシステム実装方法調査

## 調査日
2026年01月05日

## 調査目的
デッキと駒にコストの概念を導入し、デッキ作成画面でコストを表示できるようにするための実装方法を調査する。

## 要件

### 基本要件
1. **駒のコスト**: 駒が持つすべての移動ルールのコスト合計 + スキルのコスト
2. **デッキのコスト**: デッキに含まれる駒のコストの合計
3. **表示場所**: デッキ作成画面（`deckmake.html`）のみ
4. **コスト制限**: 今回は実装せず、表示のみ

### 現状の構造
- `KomaRule` 列挙型: 24種類の移動ルール（`UP`, `DOWN`, `LINE_UP` など）
- `KomaSkill` 列挙型: 2種類のスキル（`NULL`, `STEALTH`）
- `Koma` クラス: 駒情報を保持（名前、ルールリスト、スキル）
- `Deck` クラス: デッキ情報を保持（名前、SFEN形式の盤面配置）

## 実装方法の検討

### 方法1: enum に定数として定義（推奨）

**概要**
`KomaRule` と `KomaSkill` の列挙型にコストフィールドを追加する。

**メリット**
- 実装が簡単でわかりやすい
- コストと移動ルール/スキルが一体化し、保守性が高い
- データベース変更不要
- コスト値の変更はコードの修正とコンパイルで完結

**デメリット**
- コスト値の変更にはコードの修正が必要
- アプリケーション再起動が必要

**実装例**

```java
// KomaRule.java
public enum KomaRule {
  UP(1),
  DOWN(1),
  LEFT(1),
  RIGHT(1),
  UP_LEFT(1),
  UP_RIGHT(1),
  DOWN_LEFT(1),
  DOWN_RIGHT(1),
  LINE_UP(3),
  LINE_DOWN(3),
  LINE_LEFT(3),
  LINE_RIGHT(3),
  LINE_UP_LEFT(3),
  LINE_UP_RIGHT(3),
  LINE_DOWN_LEFT(3),
  LINE_DOWN_RIGHT(3),
  JUMP_UP_LEFT(2),
  JUMP_UP_RIGHT(2),
  JUMP_DOWN_LEFT(2),
  JUMP_DOWN_RIGHT(2),
  JUMP_LEFT_UP(2),
  JUMP_LEFT_DOWN(2),
  JUMP_RIGHT_UP(2),
  JUMP_RIGHT_DOWN(2);

  private final int cost;

  KomaRule(int cost) {
    this.cost = cost;
  }

  public int getCost() {
    return cost;
  }
}

// KomaSkill.java
public enum KomaSkill {
  NULL(0),
  STEALTH(5);

  private final int cost;

  KomaSkill(int cost) {
    this.cost = cost;
  }

  public int getCost() {
    return cost;
  }
}
```

**コスト計算ロジック**

```java
// Koma.java に追加
public int getCost() {
  int totalCost = 0;
  // 移動ルールのコスト合計
  for (KomaRule rule : rules) {
    totalCost += rule.getCost();
  }
  // スキルのコスト
  totalCost += skill.getCost();
  return totalCost;
}
```

### 方法2: データベースにコストテーブルを作成

**概要**
`RuleCost` と `SkillCost` テーブルを作成し、各ルール/スキルのコストを保存する。

**メリット**
- コスト値の動的変更が可能
- 管理画面を作れば、アプリケーション再起動なしで変更可能

**デメリット**
- 実装が複雑（テーブル作成、Mapper作成、サービス層の実装が必要）
- 初期データの投入が必要
- 現時点では過剰設計の可能性が高い

**実装イメージ**

```sql
CREATE TABLE RuleCost(
  rule VARCHAR(50) PRIMARY KEY,
  cost INT NOT NULL
);

CREATE TABLE SkillCost(
  skill VARCHAR(50) PRIMARY KEY,
  cost INT NOT NULL
);
```

## 推奨実装方法

**方法1（enum に定数として定義）** を推奨します。

**理由**
1. 要件が「実装が簡単でわかりやすい方法」であること
2. 現時点ではコスト値の頻繁な変更は想定されていない
3. データベーススキーマの変更が不要
4. コードの可読性・保守性が高い

## コスト値の提案

### 移動ルールのコスト
- **単マス移動** (`UP`, `DOWN`, `LEFT`, `RIGHT`, `UP_LEFT`, `UP_RIGHT`, `DOWN_LEFT`, `DOWN_RIGHT`): **1**
- **直線移動** (`LINE_*`): **3**
- **ジャンプ移動** (`JUMP_*`): **2**

### スキルのコスト
- **NULL**: **0**
- **STEALTH**: **5**

これらの値は将棋の駒の強さを参考に設定していますが、バランス調整は後で行うことを前提としています。

## デッキ作成画面での表示方法

### 表示する情報
1. 選択中の駒のコスト（駒選択時にリアルタイム表示）
2. 盤面に配置された駒の合計コスト（デッキコスト）

### 実装方法
1. **KomaDB にコスト情報を追加**
   `KomaMapper` で駒情報を取得する際に、その駒のコストも計算して返す

2. **フロントエンドでコスト表示**
   - 駒選択時に、その駒のコストを表示
   - 盤面に駒を配置するたびに、デッキの合計コストを再計算して表示

3. **コスト計算のエンドポイント追加（オプション）**
   `/deck/cost` などのエンドポイントを作成し、駒IDのリストからコストを計算するAPIを提供

## 必要な実装ファイル

### バックエンド
1. `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaRule.java` - コストフィールド追加
2. `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaSkill.java` - コストフィールド追加
3. `tkk_game/src/main/java/team3/tkk_game/model/Koma/Koma.java` - `getCost()` メソッド追加
4. `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java` - コスト計算メソッド追加（オプション）
5. `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java` - 駒リストにコスト情報を含める

### フロントエンド
1. `tkk_game/src/main/resources/templates/deckmake.html` - コスト表示UI追加

## 参考情報
- Spring Boot の enum の使い方: [Baeldung - Guide to Java Enums](https://www.baeldung.com/java-enums)
- Thymeleaf でのオブジェクト表示: [Thymeleaf Tutorial](https://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html)

## 次のステップ
調査結果を基に、計画フェーズで詳細な実装計画を立てる。
