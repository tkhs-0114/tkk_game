# 駒作成機能実装計画

## 計画作成日
2026年1月4日

## 目的
`komamake.html`のフォームから送信された駒データ（名前、移動ルール、成り先）をDBに保存し、カスタム駒を作成できる機能を実装する。

## 背景・現状の問題点

### 現在の実装状況
- フォーム画面（`komamake.html`）は完成
- `DeckController.saveKomaData`メソッドは存在するが、処理が未実装
- `KomaMapper`にはINSERTメソッドが定義されているが、一部修正が必要

### 調査で判明した修正箇所
| 項目 | 状態 | 必要な対応 |
|------|------|------------|
| フォームのデフォルト値 | ✅ 完了 | `<option value="-1">`に修正済み |
| `insertKomaRule`のカラム名 | ✅ 完了 | `rule_name` → `rule`に修正済み |
| `insertKoma`の`@Options` | ✅ 完了 | アノテーション追加済み |
| `insertKoma`の引数型 | ❌ 未対応 | 個別フィールド → `KomaDB`オブジェクトに変更必要 |
| Controller実装 | ❌ 未対応 | フォーム受け取り＆DB保存処理の実装 |

## 前提条件
- Spring Boot + MyBatis環境
- トランザクション管理が有効（`@Transactional`使用可能）
- `KomaDB`クラスにgetter/setterが実装済み
- `KomaRule` enumが定義済み

## スコープ（含む）
- `KomaMapper.insertKoma`メソッドの引数変更
- `DeckController.saveKomaData`メソッドの実装
- トランザクション処理の追加
- エラーハンドリング

## スコープ（含まない）
- フロントエンド（JavaScript）の実装
- バリデーション機能の追加（今後の拡張として検討）
- 駒の削除・編集機能

---

## タスク一覧

### タスク1: KomaMapperの修正

**優先度**: 1（最優先）

**関連ファイル**:
- 修正: `tkk_game/src/main/java/team3/tkk_game/mapper/KomaMapper.java`
- 参照: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java`

**作業内容**:
1. `insertKoma`メソッドのシグネチャを変更
   - 変更前: `void insertKoma(String name, String skill, Integer updateKoma)`
   - 変更後: `void insertKoma(KomaDB koma)`

**期待される結果**:
- `insertKoma`実行後、引数の`KomaDB`オブジェクトの`id`フィールドに自動採番されたIDが設定される
- `@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")`が正しく機能する

**実装コード**:
```java
@Insert("INSERT INTO koma(name, skill, update_koma) VALUES(#{name}, #{skill}, #{updateKoma})")
@Options(useGeneratedKeys = true, keyColumn = "id", keyProperty = "id")
void insertKoma(KomaDB koma);
```
---

### タスク2: DeckControllerの実装

**優先度**: 2

**関連ファイル**:
- 修正: `tkk_game/src/main/java/team3/tkk_game/controller/DeckController.java`
- 参照: `tkk_game/src/main/java/team3/tkk_game/mapper/KomaMapper.java`
- 参照: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaDB.java`
- 参照: `tkk_game/src/main/java/team3/tkk_game/model/Koma/KomaRule.java`

**作業内容**:
1. `saveKomaData`メソッドの引数を追加
   - `name`: String（既存）
   - `rules`: List<String>（新規、`required = false`）
   - `updateKomaId`: Integer（新規、`required = false`）

2. `@Transactional`アノテーションを追加

3. 処理ロジックの実装
   - `KomaDB`オブジェクトを作成
   - `komaMapper.insertKoma()`を呼び出し
   - `rules`をループして`komaMapper.insertKomaRule()`を呼び出し

4. エラーハンドリング
   - try-catch文で`RuntimeException`を捕捉
   - エラー時のリダイレクト先を検討

**実装コード**:
```java
@PostMapping("make/koma/save")
@Transactional
public String saveKomaData(
    @RequestParam String name,
    @RequestParam(required = false) List<String> rules,
    @RequestParam(required = false) Integer updateKomaId,
    Principal principal) {

  try {
    // 1. KomaDBオブジェクトを作成
    KomaDB newKoma = new KomaDB();
    newKoma.setName(name);
    newKoma.setSkill(null); // 今回のフォームではskillは設定しない
    newKoma.setUpdateKoma(updateKomaId != null ? updateKomaId : -1);

    // 2. komaテーブルにInsert（IDが自動採番される）
    komaMapper.insertKoma(newKoma);

    // 3. komaruleテーブルへの挿入
    if (rules != null && !rules.isEmpty()) {
      for (String ruleName : rules) {
        KomaRule komaRule = KomaRule.valueOf(ruleName);
        komaMapper.insertKomaRule(newKoma.getId(), komaRule);
      }
    }

  } catch (RuntimeException e) {
    // エラーログ出力（将来的にはログフレームワークを使用）
    System.err.println("駒の保存に失敗しました: " + e.getMessage());
    e.printStackTrace();
    // トランザクションがロールバックされる
  }

  return "redirect:/deck/make";
}
```

**必要なimport文**:
```java
import java.util.List;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RequestParam;
```

**テスト方法**:
- 人間が手で確認する為、不要

---

## 参考資料
- 調査レポート: `docs/reports/investigate/2026-01-04_駒作成フォームのDB保存実装方法調査.md`
- igakilab/springboot_samples: https://github.com/igakilab/springboot_samples
  - Sample41Controller.java
  - ChamberMapper.java

## 備考
- 将来的な拡張として、以下を検討:
  - 駒名のバリデーション（文字数制限、重複チェック）
  - 駒の削除・編集機能
  - 駒のプレビュー機能
  - エラーメッセージの表示（Thymeleafでフラッシュメッセージ）
