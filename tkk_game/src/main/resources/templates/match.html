<script th:inline="javascript">
  let matchTmp = 'none';
  let isInWaitRoom = false; // 自分が待機室に入っているかどうか
  const playerName = /*[[${playerName}]]*/ 'defaultPlayer';
  window.onload = function () {
    console.log('Player Name:', playerName);
    const sse = new EventSource('/waitRoom');
    sse.onmessage = function (event) {
      const players = JSON.parse(event.data);
      console.log(players);
      console.log('matchTmp:', matchTmp);
      console.log('Player Name:', playerName);
      console.log('isInWaitRoom:', isInWaitRoom);

      const isCurrentlyInRoom = players.some(p => p.name === playerName);

      // 誰かに対戦リクエストを送られた場合（以前は待機室にいたが、今はいない）
      if (isInWaitRoom && !isCurrentlyInRoom) {
        window.location.href = '/gameStart';
        return;
      }

      // 待機室の状態を更新
      isInWaitRoom = isCurrentlyInRoom;

      // 自分から対戦リクエストを送信する
      if (matchTmp !== 'none' && players.some(p => p.name === matchTmp)) {
        window.location.href = `/gameStart?player2Name=${matchTmp}`;
        return;
      }
      updatePlayerTable(players);
    };
  };

  function updatePlayerTable(players) {
    const tbody = document.getElementById('playerTableBody');
    let html = '';
    players.forEach(function (player) {
      if (player.name === playerName) {
        return; // 自分自身は表示しない
      }
      html += `<tr>`;
      html += `<td>${player.name}</td>`;
      html += `<td><a href="#" onClick="matchTmp='${player.name}'; return false;">対戦</a></td>`;
      html += `</tr>`;
    });
    tbody.innerHTML = html;
  }

</script>

<h1>マッチング画面</h1>
<table>
  <tr>
    <th>参加プレイヤー一覧</th>
  </tr>
  <tbody id="playerTableBody"></tbody>
</table>
<a href="/makeRoom">ルーム作成</a>
<br>
<a href="/home">ホームに戻る</a>
