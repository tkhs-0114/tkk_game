<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link th:href="@{/css/match.css}" rel="stylesheet">
  <title>マッチング</title>
  <script th:inline="javascript">
    const playerName = /*[[${playerName}]]*/ 'defaultPlayer';
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfParameterName = /*[[${_csrf.parameterName}]]*/ '_csrf';

    // 自分がリクエストを送ったルームのオーナー名を記憶
    let myRequestTo = null;

    window.onload = function () {
      console.log('Player Name:', playerName);

      // ページ離脱時のSSE接続クリーンアップ
      let sse = null;
      window.addEventListener('beforeunload', function (event) {
        if (sse) {
          sse.close();
        }
      });

      sse = new EventSource('/match/waitRoom');
      sse.onmessage = function (event) {
        const rooms = JSON.parse(event.data);
        console.log('待機中ルーム:', rooms);

        // 自分がリクエストを送ったルームを探す
        const myRequestedRoom = rooms.find(r => r.player2?.name === playerName);
        if (myRequestedRoom) {
          myRequestTo = myRequestedRoom.player1.name;
        }

        // 自分がリクエストを送っていた場合
        if (myRequestTo) {
          const targetRoom = rooms.find(r => r.player1.name === myRequestTo);
          if (!targetRoom) {
            // ルームが消えた時
            console.log('対戦リクエストが承認されました！');
            sse.close();
            window.location.href = `/game`;
            return;
          } else if (targetRoom.player2?.name !== playerName) {
            // ルームはあるが自分のリクエストが無い時
            console.log('対戦リクエストが拒否されました');
            myRequestTo = null;
          }
        }
        updatePlayerTable(rooms);
      };
    };

    function updatePlayerTable(players) {
      const tbody = document.getElementById('playerTableBody');
      let html = '';
      players.forEach(function (player) {
        if (player.player1.name === playerName) {
          return; // 自分自身は表示しない
        }
        html += `<tr>`;
        html += `<td>${player.player1.name}</td>`;
        html += `<td>`;
        if (player.player2?.name === playerName) {
          html += `<span class="status-text">[リクエスト送信済み]</span>`;
        } else if (player.player2 !== null) {
          html += `<span class="status-text">[他のプレイヤーがリクエスト中]</span>`;
        }
        else if (myRequestTo !== null) {
          html += `<span class="status-text">[他のプレイヤーにリクエスト中]</span>`;
        } else {
          html += `<form action="/match/sendRequest?Player1Name=${player.player1.name}" method="post">`;
          html += `<input type="hidden" name="${csrfParameterName}" value="${csrfToken}">`;
          html += `<button type="submit">対戦リクエスト</button>`;
          html += `</form>`;
        }
        html += `</td>`;
        html += `</tr>`;
      });
      tbody.innerHTML = html;
    }
  </script>
</head>

<body>
  <div class="container">
    <header>
      <h1>マッチング</h1>
    </header>

    <div class="room-table">
      <table>
        <thead>
          <tr>
            <th>ルーム一覧</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="playerTableBody"></tbody>
      </table>
    </div>

    <div class="actions">
      <a href="/match/makeRoom" class="action-button">ルーム作成</a>
    </div>

    <nav class="menu">
      <a href="/home" class="menu-item">ホームに戻る</a>
    </nav>
  </div>
</body>

</html>
