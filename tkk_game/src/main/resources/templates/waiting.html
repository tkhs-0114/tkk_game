<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link th:href="@{/css/waiting.css}" rel="stylesheet">
  <title>対戦相手待機中</title>
  <script th:inline="javascript">
    const playerName = /*[[${playerName}]]*/ 'defaultPlayer';

    window.onload = function () {
      console.log('待機中... Player Name:', playerName);

      // SSE接続を開始
      const sse = new EventSource('/match/waitRoom');
      sse.onmessage = function (event) {
        const rooms = JSON.parse(event.data);
        console.log('待機室:', rooms);

        // 自分のルームを取得
        const myRoom = rooms.find(r => r.player1.name === playerName);

        // リクエストがあるかチェック
        const haveRequest = document.getElementById('haveRequest');
        const waitingMessage = document.getElementById('waitingMessage');
        const P2NameSpan = document.getElementById('P2Name');

        if (myRoom.player2) {
          // リクエストがある場合
          P2NameSpan.textContent = myRoom.player2.name;
          haveRequest.style.display = 'block';
          waitingMessage.style.display = 'none';
        } else {
          // リクエストがない場合
          haveRequest.style.display = 'none';
          waitingMessage.style.display = 'block';
        }
      };
    };
  </script>
</head>

<body>
  <div class="container">
    <header>
      <h1>対戦相手を待っています</h1>
    </header>

    <div class="player-info">
      <p>プレイヤー名: <span class="player-name" th:text="${playerName}"></span></p>
    </div>

    <!-- 待機中メッセージ -->
    <div id="waitingMessage" class="waiting-message">
      <p>対戦リクエストを待っています<span class="dots"></span></p>
    </div>

    <!-- リクエストがある場合の表示 -->
    <div id="haveRequest" class="request-section" style="display: none;">
      <h2>対戦リクエストが届いています！</h2>
      <p><span id="P2Name" class="requester-name"></span> さんから対戦リクエストがあります。</p>
      <div class="button-container">
        <form th:action="@{/match/accept}" method="post">
          <button type="submit" class="btn-accept">承認する</button>
        </form>
        <form th:action="@{/match/reject}" method="post">
          <button type="submit" class="btn-reject">拒否する</button>
        </form>
      </div>
    </div>

    <nav class="menu">
      <a href="/match" class="menu-item">キャンセル</a>
    </nav>
  </div>
</body>

</html>
