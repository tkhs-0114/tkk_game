<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="utf-8">
  <title>対戦相手待機中</title>
  <script th:inline="javascript">
    const playerName = /*[[${playerName}]]*/ 'defaultPlayer';

    window.onload = function () {
      console.log('待機中... Player Name:', playerName);
      
      // SSE接続を開始
      const sse = new EventSource('/match/waitRoom');
      sse.onmessage = function (event) {
        const rooms = JSON.parse(event.data);
        console.log('待機室:', rooms);

        // 自分のルームを取得
        const myRoom = rooms.find(r => r.player1.name === playerName);

        // リクエストがあるかチェック
        const haveRequest = document.getElementById('haveRequest');
        const waitingMessage = document.getElementById('waitingMessage');
        const P2NameSpan = document.getElementById('P2Name');

        if (myRoom.player2) {
          // リクエストがある場合
          P2NameSpan.textContent = myRoom.player2.name;
          haveRequest.style.display = 'block';
          waitingMessage.style.display = 'none';
        } else {
          // リクエストがない場合
          haveRequest.style.display = 'none';
          waitingMessage.style.display = 'block';
        }
      };
    };
  </script>
</head>

<body>
  <h1>対戦相手を待っています...</h1>
  <p>プレイヤー名: <span th:text="${playerName}"></span></p>
  
  <!-- 待機中メッセージ -->
  <div id="waitingMessage">
    <p>対戦リクエストを待っています...</p>
  </div>

  <!-- リクエストがある場合の表示 -->
  <div id="haveRequest" style="display: none;">
    <h2>対戦リクエストが届いています！</h2>
    <p><span id="P2Name"></span> さんから対戦リクエストがあります。</p>
    <form th:action="@{/match/accept}" method="post" style="display: inline;">
      <button type="submit">承認する</button>
    </form>
    <form th:action="@{/match/reject}" method="post" style="display: inline;">
      <button type="submit">拒否する</button>
    </form>
  </div>
  
  <br>
  <a href="/match">キャンセル</a>
</body>

</html>
