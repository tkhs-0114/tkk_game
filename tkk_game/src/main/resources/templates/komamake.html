<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link th:href="@{/css/preview.css}" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Boku&display=swap" rel="stylesheet">
  <title>ゲーム</title>
  <script th:inline="javascript">
    const ban = /*[[${ban}]]*/ null;

    // 選択中のルールとスキルのコストを計算して表示
    function updateTotalCost() {
      // 移動ルールのコスト計算
      let ruleCost = 0;
      document.querySelectorAll('.rule-checkbox:checked').forEach(checkbox => {
        const cost = parseInt(checkbox.getAttribute('data-cost'));
        if (!isNaN(cost)) {
          ruleCost += cost;
        }
      });
      document.getElementById('rule-cost-display').textContent = ruleCost;

      // スキルのコスト計算
      let skillCost = 0;
      const selectedSkill = document.querySelector('.skill-radio:checked');
      if (selectedSkill) {
        const cost = parseInt(selectedSkill.getAttribute('data-cost'));
        if (!isNaN(cost)) {
          skillCost = cost;
        }
      }
      document.getElementById('skill-cost-display').textContent = skillCost;

      // 合計コスト表示
      const totalCost = ruleCost + skillCost;
      document.getElementById('total-cost-display').textContent = totalCost;
    }

    function drawBoard() {
      const boardContainer = document.getElementById('board-container');
      if (!ban || !ban.board) {
        boardContainer.innerHTML = '<p>盤面データがありません</p>';
        return;
      }

      let html = '<table border="1">';

      const boardLength = ban.board.length;

      for (let y = 3; y < boardLength; y++) {
        html += '<tr>';
        for (let x = 0; x < boardLength; x++) {
          const cell = ban.board[x][y];

          let cellContent = (cell && cell.name) ?
            `<div class="cell koma">${cell.name}</div>`
            : `<div class="cell">　</div>`;
          html += `<td>${cellContent}</td>`;
        }
        html += '</tr>';
      }

      html += '</table>';
      boardContainer.innerHTML = html;
    }
    window.onload = function () {
      // 盤面を描画
      drawBoard();
      window.addEventListener('DOMContentLoaded', updateTotalCost);
    };
  </script>
</head>

<body>
  <div class="game-board-layout">
    <div id="board-container">
      <!-- 盤面がここに表示されます -->
    </div>
  </div>
  <form th:action="@{/deck/make/koma/save}" method="post" onchange="updateTotalCost()">
    <label for="name">駒の名前:<input type="text" id="name" name="name" required></label><br>

    <div>
      <strong>合計コスト：</strong><span id="total-cost-display">0</span>
      <span>(移動ルール: <span id="rule-cost-display">0</span> + 特殊スキル: <span id="skill-cost-display">0</span>)</span>
    </div>

    <div>
      <strong>移動ルール:</strong><br>
      <div th:each="rule : ${availableRules}">
        <label>
          <input type="checkbox" class="rule-checkbox" th:id="${rule.name()}" name="rules" th:value="${rule.name()}"
            th:data-cost="${rule.cost}">
          <span th:text="${rule.name()}">ルール名</span>
          <span th:text="'(コスト: ' + ${rule.cost} + ')'">コスト</span>
        </label>
      </div>
    </div>

    <div>
      <strong>特殊スキル (1つのみ選択可能):</strong><br>
      <div th:each="skill : ${availableSkills}" style="margin:5px 0;">
        <label>
          <input type="radio" class="skill-radio" th:id="${skill.name()}" name="skill" th:value="${skill.name()}"
            th:data-cost="${skill.cost}" th:checked="${skill.name() == 'NULL'}">
          <span th:text="${skill.name()}">スキル名</span>
          <span th:text="'(コスト: ' + ${skill.cost} + ')'">コスト</span>
        </label>
      </div>
    </div>

    <label>駒の成り先<select id="update" name="updateKomaId">
        <option value="-1" selected>成らない</option>
        <option th:each="k : ${canUpdateKomas}" th:value="${k.id}" th:text="${k.name}">駒名</option>
      </select></label><br>
    <label><button type="submit">作成</button></label>
  </form>
</body>

</html>
