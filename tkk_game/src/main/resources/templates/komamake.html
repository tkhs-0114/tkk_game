<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link th:href="@{/css/komamake.css}" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Yuji+Boku&display=swap" rel="stylesheet">
  <title th:text="${isEditMode != null and isEditMode} ? '駒編集' : '駒作成画面'">駒作成画面</title>
  <script th:inline="javascript">
    /*<![CDATA[*/
    // 編集モードフラグと駒データを取得
    const isEditMode = /*[[${isEditMode}]]*/ false;
    const editKoma = /*[[${koma}]]*/ null;
    const currentRules = /*[[${currentRules}]]*/[];
    /*]]>*/

    // 選択中のルールとスキルのコストを計算して表示
    function updateTotalCost() {
      // 移動ルールのコスト計算
      let ruleCost = 0;
      document.querySelectorAll('.rule-checkbox:checked').forEach(checkbox => {
        const cost = parseInt(checkbox.getAttribute('data-cost'));
        if (!isNaN(cost)) {
          ruleCost += cost;
        }
      });
      document.getElementById('rule-cost-display').textContent = ruleCost;

      // スキルのコスト計算
      let skillCost = 0;
      const skillSelect = document.getElementById('skill');
      console.log(skillSelect);
      if (skillSelect) {
        const selectedOption = skillSelect.options[skillSelect.selectedIndex];
        const cost = parseInt(selectedOption.getAttribute('data-cost'));
        if (!isNaN(cost)) {
          skillCost = cost;
        }
      }
      // document.getElementById('skill-cost-display').textContent = skillCost;

      // 成り先コスト計算
      let updateKomaCost = 0;
      const updateSelect = document.getElementById('updateKoma');
      console.log(updateSelect);
      if (updateSelect) {
        const selectedOption = updateSelect.options[updateSelect.selectedIndex];
        const cost = parseInt(selectedOption.getAttribute('data-cost'));
        if (!isNaN(cost)) {
          updateKomaCost = cost;
        }
      }

      // 合計コスト表示
      const totalCost = ruleCost + skillCost + updateKomaCost;
      document.getElementById('total-cost-display').textContent = totalCost;
    }

    function isLineRule(str) {
      return str.startsWith('LINE_');
    }

    function changeKomaRule(rule) {
      const ruleCheckbox = document.getElementById(rule);
      ruleCheckbox.checked = !ruleCheckbox.checked;
      if (ruleCheckbox.checked) {
        let toggleRule;
        if (isLineRule(rule)) {
          toggleRule = rule.substring(5); // 'LINE_'を削除して基本ルール名を取得
        } else {
          toggleRule = `LINE_${rule}`; // 'LINE_'を付加してLINEルール名を取得
        }
        const toggleCheckbox = document.getElementById(toggleRule);
        if (toggleCheckbox) {
          toggleCheckbox.checked = false; // 対応するルールのチェックを外す
        }
      }
      update();
    }

    function drawBoard() {
      const boardContainer = document.getElementById('board-container');
      const komaName = document.getElementById('name').value || '駒名';

      const ruleBoard = [
        ['LINE_UP_LEFT', '', '', 'LINE_UP', '', '', 'LINE_UP_RIGHT'],
        ['', 'LINE_UP_LEFT', 'JUMP_UP_LEFT', 'LINE_UP', 'JUMP_UP_RIGHT', 'LINE_UP_RIGHT', ''],
        ['', 'JUMP_LEFT_UP', 'UP_LEFT', 'UP', 'UP_RIGHT', 'JUMP_RIGHT_UP', ''],
        ['LINE_LEFT', 'LINE_LEFT', 'LEFT', '駒', 'RIGHT', 'LINE_RIGHT', 'LINE_RIGHT'],
        ['', 'JUMP_LEFT_DOWN', 'DOWN_LEFT', 'DOWN', 'DOWN_RIGHT', 'JUMP_RIGHT_DOWN', ''],
        ['', 'LINE_DOWN_LEFT', 'JUMP_DOWN_LEFT', 'LINE_DOWN', 'JUMP_DOWN_RIGHT', 'LINE_DOWN_RIGHT', ''],
        ['LINE_DOWN_LEFT', '', '', 'LINE_DOWN', '', '', 'LINE_DOWN_RIGHT'],
      ]



      let html = '<table border="1">';

      const boardLength = 7;

      for (let y = 0; y < boardLength; y++) {
        html += '<tr>';
        for (let x = 0; x < boardLength; x++) {
          let cellContent;
          let rule = ruleBoard[y][x];
          if (rule === '') {
            cellContent = `<div class="cell">　</div>`;
            html += `<td>${cellContent}</td>`;
            continue;
          }
          if (x === 3 && y === 3) {
            cellContent = `<div class="cell koma">${komaName}</div>`;
            html += `<td>${cellContent}</td>`;
            continue;
          }

          const onClick = rule ? `onClick="changeKomaRule('${rule}')" ` : '';

          const checkbox = document.getElementById(rule);
          let checked = (checkbox && checkbox.checked);
          if (!isLineRule(rule) && !checked) {
            const checkbox = document.getElementById(`LINE_${rule}`);
            checked = (checkbox && checkbox.checked);
          }
          const movAble = checked ? 'movable' : '';

          cellContent = `<div class="cell ${movAble}" ${onClick}>　</div>`;
          html += `<td>${cellContent}</td>`;
        }
        html += '</tr>';
      }

      html += '</table>';
      boardContainer.innerHTML = html;
    }
    function update() {
      drawBoard();
      updateTotalCost();
    }
    window.onload = function () {
      // 盤面を描画
      update();
    };
  </script>
</head>

<body>
  <div class="container">
    <header class="header">
      <h1 th:text="${isEditMode != null and isEditMode} ? '駒編集' : '駒作成'">駒作成</h1>
    </header>

    <form th:action="@{/koma/save}" method="post">
      <!-- 編集モードの場合、駒IDをhiddenフィールドで送信 -->
      <input type="hidden" name="komaId" th:if="${isEditMode != null and isEditMode}" th:value="${koma.id}" />
      <!-- 駒の名前入力 -->
      <div class="form-section">
        <div class="form-group">
          <label for="name">駒の名前</label>
          <input type="text" id="name" name="name" th:value="${koma?.name}" required onchange="update()"
            placeholder="駒の名前を入力してください">
        </div>
      </div>

      <!-- コスト表示 -->
      <div class="cost-display">
        <strong>移動コスト：</strong><span id="rule-cost-display">0</span>
      </div>

      <!-- 盤面表示 -->
      <div class="game-board-layout">
        <div id="board-container">
          <!-- 盤面がここに表示されます -->
        </div>
      </div>

      <!-- 隠しチェックボックス（移動ルール） -->
      <div th:each="rule : ${availableRules}" style="display: none;">
        <label>
          <input type="checkbox" class="rule-checkbox" th:id="${rule.name()}" name="rules" th:value="${rule.name()}"
            th:data-cost="${rule.cost}" th:checked="${#lists.contains(currentRules, rule)}">
          <span th:text="${rule.name()}">ルール名</span>
          <span th:text="'(コスト: ' + ${rule.cost} + ')'">コスト</span>
        </label>
      </div>

      <!-- スキルと成り先の選択 -->
      <div class="form-section">
        <div class="form-group">
          <label for="skill">スキル</label>
          <select id="skill" name="skill" onchange="update()">
            <option th:each="skill : ${availableSkills}" th:value="${skill.name()}"
              th:selected="${koma?.skill == skill.name() || (koma?.skill == null && skill.name() == 'NULL')}"
              th:data-cost="${skill.cost}"
              th:text="${skill.name() == 'NULL' ? 'なし' : skill.name()} + ' (コスト: ' + ${skill.cost} + ')'">スキル名</option>
          </select>
        </div>

        <div class="form-group">
          <label for="updateKoma">成り先</label>
          <select id="updateKoma" name="updateKomaId" onchange="update()">
            <option value="-1" th:selected="${koma?.updateKoma == null || koma?.updateKoma == -1}" data-cost="0">成らない
            </option>
            <!-- <option th:each="k : ${canUpdateKomas}" th:value="${k.id}" th:text="${k.name}"
              th:selected="${koma?.updateKoma == k.id}">駒名</option> -->
            <option value="11" th:selected="${koma?.updateKoma == 11}" data-cost="3">成金（コスト：3）</option>
            <option value="12" th:selected="${koma?.updateKoma == 12}" data-cost="6">馬（コスト：6）</option>
            <option value="13" th:selected="${koma?.updateKoma == 13}" data-cost="6">龍（コスト：6）</option>
          </select>
        </div>
      </div>

      <!-- コスト表示 -->
      <div class="cost-display">
        <strong>合計コスト：</strong><span id="total-cost-display">0</span>
      </div>

      <!-- 作成/更新ボタン -->
      <div class="button-area">
        <button type="submit" class="submit-button"
          th:text="${isEditMode != null and isEditMode} ? '更新' : '作成'">作成</button>
        <a href="/koma/list" class="cancel-button" th:if="${isEditMode != null and isEditMode}">キャンセル</a>
      </div>
    </form>
  </div>
</body>

</html>
