<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link th:href="@{/global.css}" rel="stylesheet">
  <title>ゲーム</title>
  <script th:inline="javascript">
    const ban = /*[[${ban}]]*/ null;
    const gameId = /*[[${gameId}]]*/ 'defaultGameId';
    const playerStatus = /*[[${playerStatus}]]*/ 'defaultStatus';
    const errMessage = /*[[${errMessage}]]*/ null;
    const game = /*[[${game}]]*/ null;
    const loginPlayerName = /*[[${#authentication.name}]]*/ null;
    const haveKoma = /*[[${haveKoma}]]*/ null;

    console.log(game);
    console.log(ban);
    console.log(haveKoma)

    let selectedX = null;
    let selectedY = null;
    let selectedHaveKoma = false;
    let haveKomaIndex = null;

    // 配列のインデックスを盤面の座標に変換
    function Xa2b(arrayIndex) {
      return arrayIndex - (ban.board.length - 1) / 2;
    }
    function Ya2b(arrayIndex) {
      return arrayIndex - (ban.board[0].length - 1) / 2;
    }

    function setSelectdCell(x, y) {
      selectedX = x;
      selectedY = y;
      selectedHaveKoma = false;
      console.log(`Selected cell: (${x}, ${y})`);
    }
    function sendMove(x, y) {
      if (selectedHaveKoma) {
        window.location.href = `/game/putKoma?index=${haveKomaIndex}&toX=${x}&toY=${y}`;
      } else {
        if (selectedX === null || selectedY === null) {
          alert('セルが選択されていません');
          return;
        } else {
          window.location.href = `/game/move?fromX=${selectedX}&fromY=${selectedY}&toX=${x}&toY=${y}`;
        }
      }

    }
    function drawBoard() {
      const boardContainer = document.getElementById('board-container');
      if (!ban || !ban.board) {
        boardContainer.innerHTML = '<p>盤面データがありません</p>';
        return;
      }

      let html = '<table border="1">';

      const boardLength = ban.board.length;

      for (let y = 0; y < boardLength; y++) {
        html += '<tr>';
        for (let x = 0; x < boardLength; x++) {
          const cell = ban.board[x][y];
          const cellContent = (cell && cell.name && (cell.owner.name === loginPlayerName)) ?
            `<div class="cell" onClick="setSelectdCell(${Xa2b(x)}, ${Ya2b(y)})">${cell.name}</div>`
            : (cell && cell.name) ?
              `<div class="cell" onClick="sendMove(${Xa2b(x)}, ${Ya2b(y)})">${cell.name}</div>`
              : `<div class="cell" onClick="sendMove(${Xa2b(x)}, ${Ya2b(y)})">　</div>`;
          html += `<td>${cellContent}</td>`;
        }
        html += '</tr>';
      }

      html += '</table>';
      boardContainer.innerHTML = html;
    }

    function selectHaveKoma(index) {
      selectedHaveKoma = true;
      haveKomaIndex = index;
    }
    function drawhaveKoma() {
      const haveKomaContainer = document.getElementById('haveKoma-container');
      if (!haveKoma) {
        haveKomaContainer.innerHTML = '<p>盤面データがありません</p>';
        return;
      }

      let html = '<table>';

      html += '<tr>';
      for (let i = 0; i < haveKoma.length; i++) {
        const cell = haveKoma[i];
        html += `<td><div class="cell" onClick="selectHaveKoma(${i})">${cell.name}</div></td>`;

      }
      html += '</tr>';

      html += '</table>';
      haveKomaContainer.innerHTML = html;
    }



    window.onload = function () {
      // 盤面を描画
      drawBoard();
      drawhaveKoma();

      // エラーメッセージがあれば表示
      if (errMessage) {
        alert(errMessage);
      }

      console.log('Player Status:', playerStatus);

      if (playerStatus === 'GAME_WAITING') {
        // SSE接続でターン情報を受信
        const sse = new EventSource(`/game/turn?gameId=${gameId}`);
        sse.onmessage = function (event) {
          const isNextTurn = JSON.parse(event.data);
          console.log('Is next turn:', isNextTurn);
          if (isNextTurn) {
            window.location.href = `/game`;
          }
        };
      } else {

      }

    };
  </script>
</head>

<body>
  <h1>ゲーム画面</h1>
  <p>ゲームID:[[${gameId}]]</p>
  <p>プレイヤーステータス: [[${playerStatus}]]</p>

  <div>
    <div id="board-container">
      <!-- 盤面がここに表示されます -->
    </div>
    <div id="haveKoma-container">
      <!-- 持ち駒がここに表示されます -->
    </div>
  </div>

</body>

</html>