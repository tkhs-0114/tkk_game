<script th:inline="javascript">
  const ban = /*[[${ban}]]*/ null;
  const gameId = /*[[${gameId}]]*/ 'defaultGameId';
  const playerStatus = /*[[${playerStatus}]]*/ 'defaultStatus';
  const errMessage = /*[[${errMessage}]]*/ null;
  const game = /*[[${game}]]*/ null;
  const loginPlayerName = /*[[${#authentication.name}]]*/ null;
  const isPlayer2 = game && game.player2 && game.player2.name === loginPlayerName;
  
  console.log(game);
  console.log(ban);
  console.log('isPlayer2:', isPlayer2);

  let selectedX = null;
  let selectedY = null;

  // 配列のインデックスを盤面の座標に変換
  function Xa2b(arrayIndex) {
    return arrayIndex - (ban.board.length - 1) / 2;
  }
  function Ya2b(arrayIndex) {
    return arrayIndex - (ban.board[0].length - 1) / 2;
  }

  function setSelectdCell(x, y) {
    selectedX = x;
    selectedY = y;
    console.log(`Selected cell: (${x}, ${y})`);
  }
  function sendMove(x, y) {
    if (selectedX === null || selectedY === null) {
      alert('セルが選択されていません');
      return;
    }
    window.location.href = `/game/move?fromX=${selectedX}&fromY=${selectedY}&toX=${x}&toY=${y}`;
  }
  function drawBoard() {
    const boardContainer = document.getElementById('board-container');
    if (!ban || !ban.board) {
      boardContainer.innerHTML = '<p>盤面データがありません</p>';
      return;
    }

    let html = '<table border="1">';

    const boardLength = ban.board.length;
    
    // player2の場合は盤面を反転表示
    for (let y = 0; y < boardLength; y++) {
      html += '<tr>';
      for (let x = 0; x < boardLength; x++) {
        // player2の場合は座標を反転
        const displayX = isPlayer2 ? (boardLength - 1 - x) : x;
        const displayY = isPlayer2 ? (boardLength - 1 - y) : y;
        
        const cell = ban.board[displayX][displayY];
        const cellContent = (cell && cell.name) ?
          `<div onClick="setSelectdCell(${Xa2b(displayX)}, ${Ya2b(displayY)})">${cell.name}</div>`
          : `<div onClick="sendMove(${Xa2b(displayX)}, ${Ya2b(displayY)})">　</div>`;
        html += `<td>${cellContent}</td>`;
      }
      html += '</tr>';
    }

    html += '</table>';
    boardContainer.innerHTML = html;
  }


  window.onload = function () {
    // 盤面を描画
    drawBoard();

    // エラーメッセージがあれば表示
    if (errMessage) {
      alert(errMessage);
    }

    console.log('Player Status:', playerStatus);

    if (playerStatus === 'GAME_WAITING') {
      // SSE接続でターン情報を受信
      const sse = new EventSource(`/game/turn?gameId=${gameId}`);
      sse.onmessage = function (event) {
        const isNextTurn = JSON.parse(event.data);
        console.log('Is next turn:', isNextTurn);
        if (isNextTurn) {
          window.location.href = `/game`;
        }
      };
    } else {

    }

  };
</script>

<h1>ゲーム画面</h1>
<p>ゲームID:[[${gameId}]]</p>
<p> プレイヤーステータス: [[${playerStatus}]]</p>

<div id="board-container">
  <!-- 盤面がここに表示されます -->
</div>
